name: Deploy to VM

on:
  push:
    branches: [master]
  workflow_dispatch:   # allow manual trigger from GitHub UI

jobs:
  deploy:
    # Runs on Omnius's VM via self-hosted runner (calls out to GitHub — no
    # inbound firewall rules needed). See USER-MANUAL § runner setup.
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write .env from GitHub Secrets
        run: |
          cat > ${{ github.workspace }}/.env << 'ENVEOF'
          AMAZON_ADS_CLIENT_ID=${{ secrets.AMAZON_ADS_CLIENT_ID }}
          AMAZON_ADS_CLIENT_SECRET=${{ secrets.AMAZON_ADS_CLIENT_SECRET }}
          AMAZON_ADS_REFRESH_TOKEN=${{ secrets.AMAZON_ADS_REFRESH_TOKEN }}
          AMAZON_ADS_PROFILE_ID=${{ secrets.AMAZON_ADS_PROFILE_ID }}
          META_ACCESS_TOKEN=${{ secrets.META_ACCESS_TOKEN }}
          META_AD_ACCOUNT_ID=${{ secrets.META_AD_ACCOUNT_ID }}
          GMAIL_ADDRESS=${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }}
          STATUS_EMAIL=${{ secrets.STATUS_EMAIL }}
          XAI_API_KEY=${{ secrets.XAI_API_KEY }}
          BACKUP_RCLONE_DEST=${{ secrets.BACKUP_RCLONE_DEST }}
          ENVEOF
          chmod 600 ${{ github.workspace }}/.env

      - name: Restart Docker container
        run: |
          cd ${{ github.workspace }}
          docker compose down
          docker compose up -d --build
          echo "Deploy complete."
          docker compose ps
